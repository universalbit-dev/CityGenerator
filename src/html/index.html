<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CityGenerator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap CSS (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- custom stylesheet -->
  <link rel="stylesheet" href="style.css">
  <style>
    #current-model-name { color: #0d6efd; font-weight: 700; }
    #model-tip { margin-top: .5rem; color: #6c757d; }
    .btn-round { border-radius: 12px; padding: .6rem 1.2rem; font-size: 1.05rem; }
    #manager-info { display: none; }
  </style>
</head>
<body>
  <div class="container py-3">
    <header class="mb-4">
      <h1 class="h2">CityGenerator <span class="badge bg-secondary">Deep Q-Learning</span></h1>
    </header>

    <section class="mb-3">
      <!-- Map Canvas -->
      <canvas id="map-canvas" width="900" height="360" class="border rounded d-block mb-3" style="max-width:100%; height:auto;"></canvas>

      <div class="d-flex gap-3 align-items-center">
        <button id="pause-btn" type="button" class="btn btn-warning btn-round">Pause</button>
        <button id="resume-btn" type="button" class="btn btn-success btn-round">Resume</button>
        <button id="random-city-model-btn" type="button" class="btn btn-primary btn-round">Random City Model</button>
      </div>
    </section>

    <hr>

    <!-- Manager info + Model display area -->
    <section id="manager-info" class="text-center mb-4" aria-hidden="true">
      <h3 class="h4">Current Simulation Model: <span id="current-model-name">Unknown Model</span></h3>
      <p id="model-tip" class="lead">No tip available for this model.</p>
    </section>

    <section class="mb-5">
      <h4 class="h5"></h4>
      <canvas id="state-chart" width="600" height="240" style="max-width:100%;"></canvas>
    </section>

    <section class="mb-5">
      <h4 class="h5"></h4>
      <canvas id="rewardTrendChart" width="800" height="240" style="max-width:100%;"></canvas>
    </section>
  </div>

  <!-- Bootstrap JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Lightweight helper -->
  <script>
    (function () {
      // mapping known models (optional)
      const modelTips = {};

      let lastKnownModel = null;
      let pollTimer = null;

      function setManagerVisible(visible) {
        const m = document.getElementById('manager-info');
        if (!m) return;
        m.style.display = visible ? '' : 'none';
        m.setAttribute('aria-hidden', visible ? 'false' : 'true');
      }

      function updateModelDisplay(name, tip) {
        const nameEl = document.getElementById('current-model-name');
        const tipEl = document.getElementById('model-tip');

        const normalized = (typeof name === 'string' && name.trim()) ? name.trim() : null;

        if (nameEl) nameEl.textContent = normalized || 'Unknown Model';
        if (tipEl) tipEl.textContent = tip || (normalized && modelTips[normalized]) || 'No tip available for this model.';
        setManagerVisible(Boolean(normalized));
        lastKnownModel = normalized || null;
      }
      
      window.setSimulationModelDisplay = updateModelDisplay;

      function safeGet(obj, path) {
        try {
          return path.reduce((acc, k) => (acc && acc[k] !== undefined) ? acc[k] : undefined, obj);
        } catch (e) {
          return undefined;
        }
      }

      function gatherModelCandidates() {
        const candidates = [];
        try {
          if (window.simulationModel) {
            candidates.push(window.simulationModel.name, window.simulationModel.modelName, window.simulationModel.title);
          }
        } catch (e) {}

        if (window.currentModelName) candidates.push(window.currentModelName);
        if (window.modelName) candidates.push(window.modelName);
        if (window.initialModelName) candidates.push(window.initialModelName);

        try {
          if (window.manager) {
            candidates.push(window.manager.modelName);
            candidates.push(safeGet(window, ['manager','model','name']));
            candidates.push(safeGet(window, ['manager','currentModel','name']));
            candidates.push(safeGet(window, ['manager','current','name']));
            candidates.push(safeGet(window, ['manager','name']));
          }
        } catch (e) {}

        try {
          if (window.app) {
            candidates.push(safeGet(window, ['app','model','name']));
            candidates.push(safeGet(window, ['app','currentModel','name']));
          }
        } catch (e) {}

        try {
          if (document.body && document.body.dataset && document.body.dataset.modelName) candidates.push(document.body.dataset.modelName);
          const el = document.querySelector('[data-model-name]');
          if (el) {
            candidates.push(el.dataset && el.dataset.modelName);
            candidates.push(el.getAttribute && el.getAttribute('data-model-name'));
          }
        } catch (e) {}

        return candidates.map(c => (typeof c === 'string' ? c.trim() : c)).filter(Boolean);
      }

      function inferInitialModel() {
        const candidates = gatherModelCandidates();
        return candidates.length ? candidates[0] : null;
      }

      function startPollingForModelChange() {
        if (pollTimer) return;
        pollTimer = setInterval(() => {
          const inferred = inferInitialModel();
          if (inferred && inferred !== lastKnownModel) {
            updateModelDisplay(inferred);
          }
        }, 500);
      }

      function stopPollingForModelChange() {
        if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
      }

      // Listen for an app-level event
      window.addEventListener('simulationModelChanged', function (e) {
        const d = e && e.detail ? e.detail : null;
        if (d && d.name) {
          updateModelDisplay(d.name, d.tip);
        } else {
          const inferred = inferInitialModel();
          if (inferred) updateModelDisplay(inferred);
        }
      });

      // Observe attribute/DOM changes
      const observer = new MutationObserver(function (mutationsList) {
        for (const m of mutationsList) {
          if (m.type === 'attributes' && m.attributeName && m.attributeName.startsWith('data-')) {
            const inferred = inferInitialModel();
            if (inferred && inferred !== lastKnownModel) updateModelDisplay(inferred);
          }
          if (m.type === 'childList') {
            const inferred = inferInitialModel();
            if (inferred && inferred !== lastKnownModel) updateModelDisplay(inferred);
          }
        }
      });

      document.addEventListener('DOMContentLoaded', function () {
        const inferred = inferInitialModel();
        updateModelDisplay(inferred || null, inferred ? modelTips[inferred] : null);

        startPollingForModelChange();

        try {
          if (document.body) {
            observer.observe(document.body, { attributes: true, childList: true, subtree: true });
          }
        } catch (e) {
          console.warn('Model observer failed to start', e);
        }
      });

      // Debugging helper
      window.getSimulationModelDisplay = function () {
        const name = document.getElementById('current-model-name')?.textContent || null;
        const tip = document.getElementById('model-tip')?.textContent || null;
        return { name, tip };
      };
    })();
  </script>
</body>
</html>

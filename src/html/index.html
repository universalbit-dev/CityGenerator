<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CityGenerator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet" href="style.css">
  <style>
    /* Small helper styles to improve the default look if style.css is missing */
    #current-model-name { color: #0d6efd; font-weight: 700; }
    #model-tip { margin-top: .5rem; color: #6c757d; }
    .btn-round { border-radius: 12px; padding: .6rem 1.2rem; font-size: 1.05rem; }
  </style>
</head>
<body>
  <div class="container py-3">
    <header class="mb-4">
      <h1 class="h2">CityGenerator <span class="badge bg-secondary">Deep Q-Learning</span></h1>
    </header>

    <section class="mb-3">
      <!-- Map Canvas -->
      <canvas id="map-canvas" width="900" height="360" class="border rounded d-block mb-3" style="max-width:100%; height:auto;"></canvas>

      <div class="d-flex gap-3 align-items-center">
        <button id="pause-btn" type="button" class="btn btn-warning btn-round">Pause</button>
        <button id="resume-btn" type="button" class="btn btn-success btn-round">Resume</button>
        <button id="random-city-model-btn" type="button" class="btn btn-primary btn-round">Random City Model</button>
      </div>
    </section>

    <hr>

    <!-- Manager info + Model display area -->
    <section id="manager-info" class="text-center mb-4">
      <h3 class="h4">Current Simulation Model: <span id="current-model-name">Unknown Model</span></h3>
      <p id="model-tip" class="lead">No tip available for this model.</p>
    </section>

    <section class="mb-5">
      <h4 class="h5"></h4>
      <canvas id="state-chart" width="600" height="240" style="max-width:100%;"></canvas>
    </section>

    <section class="mb-5">
      <h4 class="h5"></h4>
      <canvas id="rewardTrendChart" width="800" height="240" style="max-width:100%;"></canvas>
    </section>
  </div>

  <!-- JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    (function(){
      const candidates = [
        './main.js',                  
        'main.js',                   
        './src/html/main.js',         
        './docs/main.js',            
        window.location.pathname.replace(/\\/[^/]*$/, '') + '/main.js'  
      ].map(p => {
        // normalize double slashes
        try { return new URL(p, document.baseURI).href; } catch(e) { return p; }
      });

      function tryLoad(i){
        if (i >= candidates.length) {
          console.error('Failed to load main.js from any candidate path', candidates);
          return;
        }
        const src = candidates[i];
        const s = document.createElement('script');
        s.src = src;
        s.async = false;
        s.onload = function(){ console.info('Loaded main.js from', src); };
        s.onerror = function(){
          s.remove();
          tryLoad(i+1);
        };
        document.head.appendChild(s);
      }
      tryLoad(0);
    })();
  </script>

 
  <script>
    (function () {
 
      const modelTips = {};

      // Keep last known to avoid unnecessary DOM writes
      let lastKnownModel = null;

      function updateModelDisplay(name, tip) {
        const nameEl = document.getElementById('current-model-name');
        const tipEl = document.getElementById('model-tip');

        const normalized = (typeof name === 'string' && name.trim()) ? name.trim() : null;

        if (nameEl) nameEl.textContent = normalized || 'Unknown Model';
        if (tipEl) tipEl.textContent = tip || (normalized && modelTips[normalized]) || 'No tip available for this model.';

        lastKnownModel = normalized || null;
      }

      window.setSimulationModelDisplay = updateModelDisplay;

      function safeGet(obj, path) {
        try {
          return path.reduce((acc, k) => (acc && acc[k] !== undefined) ? acc[k] : undefined, obj);
        } catch (e) {
          return undefined;
        }
      }

      function gatherModelCandidates() {
        const candidates = [];
        try {
          if (window.simulationModel) {
            candidates.push(window.simulationModel.name);
            candidates.push(window.simulationModel.modelName);
            candidates.push(window.simulationModel.title);
          }
        } catch (e) {}
        if (window.currentModelName) candidates.push(window.currentModelName);
        if (window.modelName) candidates.push(window.modelName);
        if (window.initialModelName) candidates.push(window.initialModelName);
        try {
          if (window.manager) {
            candidates.push(window.manager.modelName);
            candidates.push(safeGet(window, ['manager','model','name']));
            candidates.push(safeGet(window, ['manager','currentModel','name']));
            candidates.push(safeGet(window, ['manager','current','name']));
            candidates.push(safeGet(window, ['manager','name']));
          }
        } catch (e) {}
        try {
          if (window.app) {
            candidates.push(safeGet(window, ['app','model','name']));
            candidates.push(safeGet(window, ['app','currentModel','name']));
          }
        } catch (e) {}
        try {
          if (document.body && document.body.dataset && document.body.dataset.modelName) candidates.push(document.body.dataset.modelName);
          const el = document.querySelector('[data-model-name]');
          if (el) {
            candidates.push(el.dataset && el.dataset.modelName);
            candidates.push(el.getAttribute && el.getAttribute('data-model-name'));
          }
        } catch (e) {}
        return candidates.map(c => (typeof c === 'string' ? c.trim() : c)).filter(Boolean);
      }

      function inferInitialModel() {
        const candidates = gatherModelCandidates();
        return candidates.length ? candidates[0] : null;
      }

      let pollTimer = null;
      function startPollingForModelChange() {
        if (pollTimer) return;
        pollTimer = setInterval(() => {
          const inferred = inferInitialModel();
          if (inferred && inferred !== lastKnownModel) {
            updateModelDisplay(inferred);
          }
        }, 500);
      }
      function stopPollingForModelChange() {
        if (pollTimer) {
          clearInterval(pollTimer);
          pollTimer = null;
        }
      }

      window.addEventListener('simulationModelChanged', function (e) {
        const d = e && e.detail ? e.detail : null;
        if (d && d.name) {
          updateModelDisplay(d.name, d.tip);
        } else {
          const inferred = inferInitialModel();
          if (inferred) updateModelDisplay(inferred);
        }
      });

      const observer = new MutationObserver(function (mutationsList) {
        for (const m of mutationsList) {
          if (m.type === 'attributes' && m.attributeName && m.attributeName.startsWith('data-')) {
            const inferred = inferInitialModel();
            if (inferred && inferred !== lastKnownModel) updateModelDisplay(inferred);
          }
          if (m.type === 'childList') {
            const inferred = inferInitialModel();
            if (inferred && inferred !== lastKnownModel) updateModelDisplay(inferred);
          }
        }
      });

      document.addEventListener('DOMContentLoaded', function () {
        const inferred = inferInitialModel();
        updateModelDisplay(inferred || 'Unknown Model', inferred ? modelTips[inferred] : null);
        startPollingForModelChange();
        try {
          if (document.body) {
            observer.observe(document.body, { attributes: true, childList: true, subtree: true });
          }
        } catch (e) {
          console.warn('Model observer failed to start', e);
        }
      });

      window.addEventListener('error', function (ev) {
        console.warn('Page error detected:', ev.message, ev.filename, ev.lineno);
      });

      window.getSimulationModelDisplay = function () {
        const name = document.getElementById('current-model-name')?.textContent || null;
        const tip = document.getElementById('model-tip')?.textContent || null;
        return { name, tip };
      };
    })();
  </script>
</body>
</html>
